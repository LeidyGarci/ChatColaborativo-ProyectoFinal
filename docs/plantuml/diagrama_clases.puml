@startuml
' ====================== CLIENTE ======================
package "Cliente" {

    ' ---------------- Config Cliente ----------------
    class ConfigCliente {
        + HOST: str
        + PORT: int
        + BUFFER: int
        + CODIFICACION: str
        + MENSAJE_BIENVENIDA: str
    }

    ' ---------------- GUI principal ----------------
    class ChatApp {
        - backend: BackendCliente
        - login_frame: LoginFrame
        - main_frame: MainMenuFrame
        - rooms_frame: RoomsFrame
        - chat_frame: ChatFrame
        - users_frame: UsersFrame
        + __init__()
        + poll_backend()
        + show_frame(frame)
        + go_main_menu()
        + go_rooms()
        + go_create()
        + go_users()
        + enter_room(sala)
        + leave_room()
        + set_username_and_connect(nombre)
    }

    ' ---------------- Backend ----------------
    class BackendCliente {
        - host: str
        - port: int
        - buffer: int
        - codificacion: str
        - socket_cliente
        - activo: bool
        - receptor_thread: Thread
        - queue: Queue
        - nombre: str
        - sala_actual: str
        + conectar(nombre)
        + _enviar_raw(texto)
        + join_room(nombre_sala)
        + leave_room()
        + send_message(texto)
        + request_rooms()
        + request_users()
        + disconnect()
        + _escuchar()
    }

    ' ---------------- Protocolo cliente ----------------
    class ProtocoloCliente {
        + procesar_respuesta(mensaje)
        + mostrar_respuesta(comando, datos)
    }

    ' ---------------- Frames GUI ----------------
    class LoginFrame {
        - backend: BackendCliente
        - entry: Entry
        + ingresar()
    }

    class MainMenuFrame {
        - backend: BackendCliente
        - lbl_welcome: Label
        + set_username(nombre)
    }

    class RoomsFrame {
        - backend: BackendCliente
        - listbox: Listbox
        + update_rooms(lista_texto)
        + refrescar()
        + entrar()
    }

    class ChatFrame {
        - backend: BackendCliente
        - sala: str
        - txt_chat: Text
        - entry_msg: Entry
        + set_room(sala)
        + append_message(texto)
        + enviar_msg()
    }

    class UsersFrame {
        - backend: BackendCliente
        - listbox: Listbox
        + update_users(texto)
    }

    ' ---------------- Relaciones Cliente ----------------
    ChatApp --> BackendCliente : usa
    ChatApp --> LoginFrame : composición
    ChatApp --> MainMenuFrame : composición
    ChatApp --> RoomsFrame : composición
    ChatApp --> ChatFrame : composición
    ChatApp --> UsersFrame : composición
    BackendCliente --> ProtocoloCliente : dependencia
    BackendCliente --> ConfigCliente : usa
    LoginFrame --> BackendCliente : dependencia
    MainMenuFrame --> BackendCliente : dependencia
    RoomsFrame --> BackendCliente : dependencia
    ChatFrame --> BackendCliente : dependencia
    UsersFrame --> BackendCliente : dependencia
}

' ====================== SERVIDOR ======================
package "Servidor" {

    ' ---------------- Config Servidor ----------------
    class ConfigServidor {
        + SERVIDOR_HOST: str
        + SERVIDOR_PUERTO: int
        + ARCHIVO_HISTORIAL: str
        + BUFFER: int
        + CODIFICACION: str
    }

    ' ---------------- Almacenamiento ----------------
    class Almacenamiento {
        - ruta: str
        - _lock: Lock
        + guardar(sala, usuario, texto)
        + obtener_historial_sala(sala)
    }

    ' ---------------- Protocolo Servidor ----------------
    class ProtocoloServidor {
        + procesar_mensaje(mensaje)
        + construir_respuesta(comando, datos="")
        + validar_comando(comando)
        - COMANDOS
    }

    ' ---------------- Núcleo Servidor ----------------
    class ServidorChat {
        - host: str
        - puerto: str
        - servidor: socket
        - clientes: dict
        - salas: dict
        - historial: Almacenamiento
        - _lock: Lock
        + iniciar()
        + manejar_cliente(cliente, direccion)
        + nombre_duplicado(nombre)
        + unirse_sala(cliente, sala)
        + retransmitir(cliente, sala, mensaje)
        + retransmitir_evento(cliente, sala, mensaje)
        + enviar_lista_usuarios(cliente)
        + enviar_lista_salas(cliente)
        + desconectar(cliente, sala)
    }

    ' ---------------- Relaciones Servidor ----------------
    ServidorChat --> ProtocoloServidor : usa
    ServidorChat --> Almacenamiento : composición
    ServidorChat --> ConfigServidor : usa
    Almacenamiento --> ConfigServidor : usa
}

' ====================== DATOS ======================
package "Datos" {
    class HistorialJSON {
        - ruta: str
        + guardar(sala, usuario, texto)
        + obtener_historial_sala(sala)
    }

    HistorialJSON --> ConfigServidor : usa
}

' ====================== INTERACCIONES CLIENTE <-> SERVIDOR ======================
BackendCliente ..> ServidorChat : conecta mediante socket (TCP)
ChatApp ..> ServidorChat : indirectamente vía BackendCliente

@enduml
